<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>Excel Query工具</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 0;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 2px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .btn {
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 0;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    #sqlInput {
      width: 100%;
      height: 40px;
      margin: 10px 0;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
    }

    #resultTable {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      overflow-x: auto;
      display: block;
    }

    #resultTable th,
    #resultTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      min-width: 100px;
    }

    #resultTable th {
      background-color: #f2f2f2;
    }

    .hidden {
      display: none;
    }

    .status {
      margin: 10px 0;
      padding: 8px;
      border-radius: 4px;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .pagination {
      margin: 15px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pagination select,
    .pagination input {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .page-info {
      color: #666;
    }
  </style>
</head>

<body>
  <div class="container">
    <h4>Excel Query 工具</h4>

    <!-- 导入 Excel 部分 -->
    <div>
      <button class="btn" onclick="openExcel()">打开 Excel 文件</button>
      <button class="btn" onclick="executeSQL()">执行 SQL</button>
      <button class="btn" onclick="exportExcel()">导出 Excel</button>

      <select id="pageSizeSelect">
        <option value="10">10 条/页</option>
        <option value="20">20 条/页</option>
        <option value="100">100 条/页</option>
        <option value="500">500 条/页</option>
      </select>

    </div>
    <!-- 执行 SQL 部分 -->
    <div>
      <textarea id="sqlInput" placeholder="输入 SQL 查询语句，例如：SELECT * FROM sheet1">SELECT * FROM sheet1</textarea>
      <div style="display: flex; gap: 10px; align-items: center;">

      </div>
    </div>

    <!-- 查询结果 -->
    <div id="resultContainer" class="hidden">
      <!-- 导出 Excel 按钮 -->

      <!-- 分页控件 -->
      <div class="pagination">
        <button class="btn" onclick="changePage(1)" id="firstPageBtn">首页</button>
        <button class="btn" onclick="changePage(-1)" id="prevPageBtn">上一页</button>
        <input type="number" id="pageNumInput" min="1" value="1" style="width: 60px;">
        <button class="btn" onclick="goToPage()">跳转</button>
        <button class="btn" onclick="changePage(1)" id="nextPageBtn">下一页</button>
        <button class="btn" onclick="changePage(0)" id="lastPageBtn">尾页</button>
        <span class="page-info" id="pageInfo">总条数：0 | 总页数：0 | 当前第 1 页</span>
      </div>

      <!-- 结果表格 -->
      <div style="overflow-x: auto;">
        <table id="resultTable"></table>
      </div>
    </div>

    <!-- 状态提示 -->
    <div id="status" class="status hidden"></div>
  </div>

  <script>
    // 全局分页参数
    let currentPage = 1;
    let totalPages = 1;
    let total = 0;
    let currentSQL = ""; // 保存当前执行的 SQL

    // 显示状态提示
    function showStatus(message, isError = false) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + (isError ? 'error' : 'success');
      status.classList.remove('hidden');
      // setTimeout(() => {
      //   status.classList.add('hidden');
      // }, 3000);
    }

    // 打开 Excel 文件
    async function openExcel() {
      try {
        showStatus('正在读取 Excel 文件...');
        const result = await window.go.main.App.OpenExcel();
        if (result.includes("数据库连接未初始化")) {
          showStatus(result, true);
          setTimeout(() => alert("数据库连接失败，请重启应用！"), 1000);
        } else {
          showStatus(result, result.includes('失败'));
        }
      } catch (error) {
        showStatus('操作失败: ' + error.message, true);
        alert("系统错误：" + error.message + "\n请重启应用！");
      }
    }

    // 执行分页 SQL 查询
    async function executeSQL() {
      const sql = document.getElementById('sqlInput').value.trim();
      const pageSize = parseInt(document.getElementById('pageSizeSelect').value);
      currentPage = 1;
      currentSQL = sql; // 保存当前 SQL

      if (!sql) {
        showStatus("请输入有效的 SQL 语句！", true);
        return;
      }

      try {
        showStatus('正在执行 SQL 查询...');
        const result = await window.go.main.App.ExecuteSQLWithPage(sql, currentPage, pageSize);

        if (result.error) {
          showStatus(result.error, true);
          return;
        }

        // 更新分页参数
        total = result.total;
        totalPages = result.totalPages;
        currentPage = result.currentPage;

        // 显示结果容器
        document.getElementById('resultContainer').classList.remove('hidden');

        // 渲染表格
        renderTable(result.columns, result.data);

        // 更新分页信息
        updatePaginationInfo();

        showStatus(result.message);
      } catch (error) {
        showStatus('SQL 执行失败: ' + error.message, true);
      }
    }

    // 渲染结果表格
    function renderTable(columns, data) {
      const table = document.getElementById('resultTable');
      table.innerHTML = '';

      // 构建表头
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      columns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // 构建表体
      const tbody = document.createElement('tbody');
      if (data.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = columns.length;
        td.textContent = '暂无数据';
        td.style.textAlign = 'center';
        tr.appendChild(td);
        tbody.appendChild(tr);
      } else {
        data.forEach(row => {
          const tr = document.createElement('tr');
          columns.forEach(col => {
            const td = document.createElement('td');
            td.textContent = row[col] || '';
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }
      table.appendChild(tbody);
    }

    // 更新分页信息
    function updatePaginationInfo() {
      const pageInfo = document.getElementById('pageInfo');
      pageInfo.textContent = `总条数：${total} | 总页数：${totalPages} | 当前第 ${currentPage} 页`;

      document.getElementById('pageNumInput').value = currentPage;
      document.getElementById('firstPageBtn').disabled = currentPage === 1;
      document.getElementById('prevPageBtn').disabled = currentPage === 1;
      document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
      document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
    }

    // 切换页码
    async function changePage(type) {
      let newPage = currentPage;
      if (type === -1) newPage = currentPage - 1;
      else if (type === 1) newPage = currentPage + 1;
      else if (type === 0) newPage = totalPages;

      if (newPage < 1 || newPage > totalPages) return;
      await loadPageData(newPage);
    }

    // 跳转到指定页码
    async function goToPage() {
      const inputPage = parseInt(document.getElementById('pageNumInput').value);
      if (isNaN(inputPage) || inputPage < 1 || inputPage > totalPages) {
        showStatus('请输入有效的页码', true);
        return;
      }
      await loadPageData(inputPage);
    }

    // 加载指定页码数据
    async function loadPageData(pageNum) {
      const pageSize = parseInt(document.getElementById('pageSizeSelect').value);
      if (!currentSQL) {
        showStatus("请先执行 SQL 查询！", true);
        return;
      }

      try {
        showStatus(`正在加载第 ${pageNum} 页数据...`);
        const result = await window.go.main.App.ExecuteSQLWithPage(currentSQL, pageNum, pageSize);

        if (result.error) {
          showStatus(result.error, true);
          return;
        }

        currentPage = result.currentPage;
        renderTable(result.columns, result.data);
        updatePaginationInfo();

        showStatus(`已加载第 ${pageNum} 页数据`);
      } catch (error) {
        showStatus('加载分页数据失败: ' + error.message, true);
      }
    }

    // 导出 Excel（核心修改：传入实时 SQL）
    async function exportExcel() {
      // 检查是否有执行过 SQL
      if (!currentSQL) {
        showStatus("请先执行 SQL 查询后再导出！", true);
        return;
      }

      try {
        showStatus('正在导出 Excel 文件（实时查询数据）...');
        // 调用重构后的导出方法，传入当前 SQL
        const result = await window.go.main.App.ExportExcelBySQL(currentSQL);
        showStatus(result, result.includes('失败'));
      } catch (error) {
        showStatus('导出失败: ' + error.message, true);
      }
    }
  </script>
</body>

</html>